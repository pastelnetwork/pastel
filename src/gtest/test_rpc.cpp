#include <gtest/gtest.h>
#include <univalue.h>

#include "chain.h"
#include "chainparams.h"
#include "clientversion.h"
#include "primitives/block.h"
#include "rpc/server.h"
#include "streams.h"
#include "utilstrencodings.h"

extern UniValue blockToJSON(const CBlock& block, const CBlockIndex* blockindex, bool txDetails = false);

TEST(rpc, check_blockToJSON_returns_minified_solution) {
    SelectParams(CBaseChainParams::Network::TESTNET);

    // Testnet block 0030b0d110441f5bdad733adcd68ad308aa96cf43aeb8bdcd57b04fed11cd56e
    // Height 4
    CDataStream ss(ParseHex("040000003e2c55a654c68204bba5b13fbc48ad731174ed0e1ba71097db08734a4c53cf00b758a79b2ec8f6734e4a7be0bc12af7e7686230d05042bec9304786a88608ba4fbc2f4300c01f0b7820d00e3347c8da4ee614674376cbc45359daa54f9b5493e0bb2785cffff07200000000000000000000000000000000000000000000000000000000000000000ffffffff0000000000000000000000000000000000000000000000000000000000000000ffffffff0000000000000000000000000000000000000000000000000000000000000000ffffffff000036a98fefa4ee22001f9c8577b706561a602cd71a16ce00315c0cc3ed0000fd40050154da8a6882d3b56624452d8c5821ea293839dacb2554521752d246b1da2d53ba67a910553dff98d1201d1c11c262d723f6c19234f2ba2e64454609cc72082982c4dddaa3cb316671833c7958ec7245b1197d870b4dc71a521edf15ec93c27a4a4609863c75b6c8cc25aeecc49529d2016310d49e6a497731e9167fc7b9292b91dd0310c640f18fd854e15cae924066b66b1b4ae753fb49e18bffda144984a17f84cea8ecb5eea408a67de4b7e8aa71e04821e5e82f7925b7df58dd07110cf955438b953da575786a33c7e422aab11f8c5409b0b969c102bd71cb45f1da10b16f712efa2a846b0c0338f5b0d3d146a132413d425c1465c83dd9d2f715a561a863a873c3e4a9b628df428349a90231bee92ffc4e900b1e24c0f12fc37cdcaaa35121db986ce736cd4e809befa40fa1e2081a68572f7228c5ff1ec749c1fcf9e8d9cf373f63ba4e80586a5ab5053c239902c6bbdb4b0cd873474843685dd1351d4ed4570b651cce9a4e9e15b9bde077c46b924b4fb2a89e1faed40e9f61192ca3bead383622a3b3e7704559f59e74832090a38ff59c92abc856f3c8dfd8e3123a37f84f110f6ba3b904e9466d572026d1b8ea862a145755df4813f8cc94e9a081cbc547447fd7d9f31a548532b6f7149350aa0bc890cf17a0d4a2372ba911911f4e8b5c4126677bd196b365b602ba99976bd4fb6d9afcd35f072091e8b0d79bcbba3203942228b9a9a4a991e43b1d55137d2160e5f3f12b6234f9d9bfe0f695effe4b090f8fc763aa02f3944b95750167e4099bdc56765c3aa4d29f4798448f113e0470dfa66c3952c7cd556a083d6ad673d1a2cdb84501c7e62b7ff084cd7f61e1358fc2e199d85f79625457b5256c72120b6633b8270cc16c8fe50759197e9be26120ee3eea863255a2f60fbc0e4c63c5424c5ab612e714790b6606afbc57ad0182967f62c1b49ef1a64161e3e88928e8a167c1a2123b2fee659e0a8520d9d3e713dae42528db6aa334103396cbb26203af719a430edd3cb8b5477f6fa547305527a7d95969732cb3135b602ed20186f9f1bf43085775eb2a6bd0b5b43d7366896d199615d37d1d3d3430c3f405e2d979397e242b18294147a4d05e552e14f9556b990c145a766084944733f7af9992fe418439559b9f8828bcd7c4fdb595cbe2ce57c78ebe3f18023e43ed3ac31f53788ae5e56bc8e8e5feba716c070888f1cbd489d3ed848d91334ab1e63e25787b75bf0d764a6ecd8cfcce7ec422e75219d9f20745f7446e23f84214103cba91f97046bf91bcdb22e87e9f2d630a9c52eca39cac010bc9b44df024eec9f7f03902910beb47350676e1ebcd375a7ca8f098f2bbf3984b6a0bff15052ed41ca1aeec88eef3e2e0979f841d8ab74014eda17ab4eec9fa7e24194729f1a14040953e7602f1d9f9385417b33eb4b058272729b5d482f6b97158799eebea6b9d8fb7d07682adcc327623721dbc06141447a12fb350a5fffa216ab5ddda106dad924c2a510a8f01295527712ec89693fac2793698339f3dea17956b3571a278636c05b3806dad90fafb9bdd07a01db06523f95bfe13bc2ae5f90d583266ca5538cbb433f915a3f9d1d6db38d5d4c57140b3927f1e1d952839e88f22716b6b9f9a90b56c87cec3b16da00c0c4d0369491c92237fc3442310f57d5d2ca65433f9e57c1e84374b35afadefaabb328ebb271bbd6219952a16057bbfdf8d859d5092ff330b4ac68af0eb5bbe7f6719df73aaf5c76a8586be62c5259bda56148432f3eb1175f35eddd57acd2d60f1969f32ed3f85b49d410630d89d5201ce97abb2e4d59518c625feda66b740b12174dfbb6193bbdf1e3ee2f58ca2faa1a91bb3a44250c216d15ce5d99552d8d5be32b19da3252c1b5d880101000000010000000000000000000000000000000000000000000000000000000000000000ffffffff03540109ffffffff0140be4025000000001976a914bd1bfac7ae0fb27ef01003ac7a46de25205e3f5b88ac00000000"), SER_DISK, CLIENT_VERSION);
    CBlock block;
    ss >> block;

    CBlockIndex index {block};
    index.nHeight = 1391;

    UniValue obj = blockToJSON(block, &index);
    EXPECT_EQ("0154da8a6882d3b56624452d8c5821ea293839dacb2554521752d246b1da2d53ba67a910553dff98d1201d1c11c262d723f6c19234f2ba2e64454609cc72082982c4dddaa3cb316671833c7958ec7245b1197d870b4dc71a521edf15ec93c27a4a4609863c75b6c8cc25aeecc49529d2016310d49e6a497731e9167fc7b9292b91dd0310c640f18fd854e15cae924066b66b1b4ae753fb49e18bffda144984a17f84cea8ecb5eea408a67de4b7e8aa71e04821e5e82f7925b7df58dd07110cf955438b953da575786a33c7e422aab11f8c5409b0b969c102bd71cb45f1da10b16f712efa2a846b0c0338f5b0d3d146a132413d425c1465c83dd9d2f715a561a863a873c3e4a9b628df428349a90231bee92ffc4e900b1e24c0f12fc37cdcaaa35121db986ce736cd4e809befa40fa1e2081a68572f7228c5ff1ec749c1fcf9e8d9cf373f63ba4e80586a5ab5053c239902c6bbdb4b0cd873474843685dd1351d4ed4570b651cce9a4e9e15b9bde077c46b924b4fb2a89e1faed40e9f61192ca3bead383622a3b3e7704559f59e74832090a38ff59c92abc856f3c8dfd8e3123a37f84f110f6ba3b904e9466d572026d1b8ea862a145755df4813f8cc94e9a081cbc547447fd7d9f31a548532b6f7149350aa0bc890cf17a0d4a2372ba911911f4e8b5c4126677bd196b365b602ba99976bd4fb6d9afcd35f072091e8b0d79bcbba3203942228b9a9a4a991e43b1d55137d2160e5f3f12b6234f9d9bfe0f695effe4b090f8fc763aa02f3944b95750167e4099bdc56765c3aa4d29f4798448f113e0470dfa66c3952c7cd556a083d6ad673d1a2cdb84501c7e62b7ff084cd7f61e1358fc2e199d85f79625457b5256c72120b6633b8270cc16c8fe50759197e9be26120ee3eea863255a2f60fbc0e4c63c5424c5ab612e714790b6606afbc57ad0182967f62c1b49ef1a64161e3e88928e8a167c1a2123b2fee659e0a8520d9d3e713dae42528db6aa334103396cbb26203af719a430edd3cb8b5477f6fa547305527a7d95969732cb3135b602ed20186f9f1bf43085775eb2a6bd0b5b43d7366896d199615d37d1d3d3430c3f405e2d979397e242b18294147a4d05e552e14f9556b990c145a766084944733f7af9992fe418439559b9f8828bcd7c4fdb595cbe2ce57c78ebe3f18023e43ed3ac31f53788ae5e56bc8e8e5feba716c070888f1cbd489d3ed848d91334ab1e63e25787b75bf0d764a6ecd8cfcce7ec422e75219d9f20745f7446e23f84214103cba91f97046bf91bcdb22e87e9f2d630a9c52eca39cac010bc9b44df024eec9f7f03902910beb47350676e1ebcd375a7ca8f098f2bbf3984b6a0bff15052ed41ca1aeec88eef3e2e0979f841d8ab74014eda17ab4eec9fa7e24194729f1a14040953e7602f1d9f9385417b33eb4b058272729b5d482f6b97158799eebea6b9d8fb7d07682adcc327623721dbc06141447a12fb350a5fffa216ab5ddda106dad924c2a510a8f01295527712ec89693fac2793698339f3dea17956b3571a278636c05b3806dad90fafb9bdd07a01db06523f95bfe13bc2ae5f90d583266ca5538cbb433f915a3f9d1d6db38d5d4c57140b3927f1e1d952839e88f22716b6b9f9a90b56c87cec3b16da00c0c4d0369491c92237fc3442310f57d5d2ca65433f9e57c1e84374b35afadefaabb328ebb271bbd6219952a16057bbfdf8d859d5092ff330b4ac68af0eb5bbe7f6719df73aaf5c76a8586be62c5259bda56148432f3eb1175f35eddd57acd2d60f1969f32ed3f85b49d410630d89d5201ce97abb2e4d59518c625feda66b740b12174dfbb6193bbdf1e3ee2f58ca2faa1a91bb3a44250c216d15ce5d99552d8d5be32b19da3252c1b5d88", find_value(obj, "solution").get_str());
}
